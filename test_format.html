<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Format Message</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-content {
            background: #f5f5f5;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .message-content {
            padding: 15px 20px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.6;
            white-space: normal;
            background: white;
            border: 1px solid #e2e8f0;
        }
        .message-content p {
            margin: 0.5em 0;
        }
        .message-content p:first-child {
            margin-top: 0;
        }
        .message-content p:last-child {
            margin-bottom: 0;
        }
        .message-content a {
            color: #4299e1;
            text-decoration: underline;
        }
        .message-content hr {
            border: none;
            border-top: 1px solid #e2e8f0;
            margin: 1em 0;
        }
        .message-content strong {
            font-weight: 600;
        }
    </style>
</head>
<body>
    <h1>Test Format Message Content</h1>
    
    <div class="test-content">
        <h2>Original Content (with \n\n):</h2>
        <pre id="original"></pre>
    </div>
    
    <div class="test-content">
        <h2>Formatted Content (HTML):</h2>
        <div class="message-content" id="formatted"></div>
    </div>

    <script>
        // Copy formatMessageContent function from app.js
        function formatMessageContent(content) {
            if (!content) return '';
            
            const linkPlaceholder = '___LINK_PLACEHOLDER___';
            const linkMap = new Map();
            let linkCounter = 0;
            
            let formatted = content.replace(/\[([^\]]+)\]\(([^)]+)\)/g, function(match, text, url) {
                const placeholder = `${linkPlaceholder}${linkCounter}`;
                linkMap.set(placeholder, { text: text, url: url });
                linkCounter++;
                return placeholder;
            });
            
            const boldPlaceholder = '___BOLD_PLACEHOLDER___';
            const boldMap = new Map();
            let boldCounter = 0;
            
            formatted = formatted.replace(/\*\*([^\*]+)\*\*/g, function(match, text) {
                const placeholder = `${boldPlaceholder}${boldCounter}`;
                boldMap.set(placeholder, text);
                boldCounter++;
                return placeholder;
            });
            
            const hrPlaceholder = '___HR_PLACEHOLDER___';
            formatted = formatted.replace(/^---$/gm, hrPlaceholder);
            
            const paragraphs = formatted.split(/\n\n+/);
            const result = [];
            
            for (let para of paragraphs) {
                para = para.trim();
                if (!para) continue;
                
                if (para === hrPlaceholder) {
                    result.push('<hr>');
                    continue;
                }
                
                para = para.replace(/\n/g, '<br>');
                
                para = para
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                
                boldMap.forEach((text, placeholder) => {
                    const escapedText = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    para = para.replace(placeholder, `<strong>${escapedText}</strong>`);
                });
                
                linkMap.forEach((linkData, placeholder) => {
                    const escapedText = linkData.text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const escapedUrl = linkData.url.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    para = para.replace(
                        placeholder,
                        `<a href="${escapedUrl}" target="_blank" rel="noopener noreferrer" class="source-link">${escapedText}</a>`
                    );
                });
                
                result.push(`<p>${para}</p>`);
            }
            
            formatted = result.join('');
            
            if (!formatted.includes('<p>') && !formatted.includes('<hr>')) {
                formatted = content
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/\n/g, '<br>');
                
                formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, 
                    '<a href="$2" target="_blank" rel="noopener noreferrer" class="source-link">$1</a>');
                formatted = formatted.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');
                
                formatted = `<p>${formatted}</p>`;
            }
            
            return formatted;
        }

        // Test content
        const testContent = `Äá»ƒ Ä‘á»‘i phÃ³ vá»›i rÄƒng sÃ¢u, báº¡n cáº§n thá»±c hiá»‡n má»™t sá»‘ biá»‡n phÃ¡p sau:\n\nSá»­ dá»¥ng kem Ä‘Ã¡nh rÄƒng chuyÃªn dá»¥ng chá»‘ng Ãª buá»‘t rÄƒng nhÆ° Sensodyne giÃºp giáº£m Ãª buá»‘t rÄƒng lÃ¢u dÃ i.\n\nBáº¡n nÃªn Ä‘Ã¡nh rÄƒng hai láº§n má»—i ngÃ y Ä‘á»ƒ giá»¯ cho rÄƒng vÃ  miá»‡ng sáº¡ch sáº½.\n\nThá»±c hiá»‡n xá»‰a rÄƒng hÃ ng ngÃ y báº±ng chá»•i hoáº·c bÃ´ng cháº£i má»m, trÃ¡nh dÃ¹ng chá»‰ Äƒn mÃ²n hoáº·c cháº¥t táº©y tráº¯ng quÃ¡ máº¡nh cÃ³ thá»ƒ gÃ¢y háº¡i cho rÄƒng.\n\nTrÃ¡nh Äƒn thá»±c pháº©m cÃ³ Ä‘á»™ acidic cao nhÆ° thá»±c pháº©m cÃ³ chá»©a axit, soda, nÆ°á»›c ngá»t cÃ³ ga... vÃ¬ chÃºng cÃ³ thá»ƒ lÃ m giáº£m Ä‘á»™ pH cá»§a miá»‡ng vÃ  khiáº¿n rÄƒng trá»Ÿ nÃªn dá»… bá»‹ sÃ¢u hÆ¡n.\n\nÄi khÃ¡m Ä‘á»‹nh ká»³ Ä‘á»ƒ bÃ¡c sÄ© kiá»ƒm tra vÃ  xá»­ lÃ½ sá»›m tÃ¬nh tráº¡ng rÄƒng sÃ¢u.\n\nBÃ¡c sÄ© cÅ©ng cÃ³ thá»ƒ tÆ° váº¥n cho báº¡n cÃ¡ch chÄƒm sÃ³c rÄƒng miá»‡ng hiá»‡u quáº£.\n\nNáº¿u báº¡n Ä‘ang gáº·p váº¥n Ä‘á» vá»›i rÄƒng hÃ m dÆ°á»›i, báº¡n nÃªn Ä‘i khÃ¡m Ä‘á»ƒ Ä‘Æ°á»£c tÆ° váº¥n cá»¥ thá»ƒ vá» cÃ¡ch kháº¯c phá»¥c.\n\n---\n\n**Nguá»“n tham kháº£o:**\n\n1. [rÄƒng hÃ m dÆ°á»›i em bá»‹ sÃ¢u bá»ƒ nhÆ°ng cÃ²n chÃ¢n rÄƒng thÃ¬ cÃ³ cÃ¡ch nÃ o ...](https://www.facebook.com/groups/370646444645899/posts/1166848891692313/)\n2. [[PDF] Bá»‹t RÄƒng - California Dental Association (CDA)](https://www.cda.org/wp-content/uploads/sealants_viet.pdf)\n3. [Sensodyne: Báº£o vá»‡ lÃ¢u dÃ i khá»i tÃ¬nh tráº¡ng Ãª buá»‘t rÄƒng](https://www.sensodyne.com/vi-vn/)\n4. [[PDF] ThÃ´ng tin cho cÃ¡c bÃ  máº¹ vÃ  ngÆ°á»i sáº¯p lÃ m máº¹!](https://www.cda.org/wp-content/uploads/new_moms_viet.pdf)\n5. [CHIA Sáºº Cá»¦A BÃC SÄ¨ NGUYá»„N THá»Š ÃNH Há»’NG - Facebook](https://www.facebook.com/nhakhoasmilehcm/videos/chia-sáº»-cá»§a-bÃ¡c-sÄ©-nguyá»…n-thá»‹-Ã¡nh-há»“ng-chuyÃªn-máº£ng-rÄƒng-tráº»-emğ—–ğ—µğ˜‚Ì‰-Ä‘ğ—²Ì‚Ì€-ğ—–ğ—®Ìğ—°ğ—µ-ğ—¹ğ—®/594951382159634/)\n`;

        document.getElementById('original').textContent = testContent;
        document.getElementById('formatted').innerHTML = formatMessageContent(testContent);
        
        console.log('Original paragraphs:', testContent.split('\\n\\n').length);
        console.log('Formatted HTML:', formatMessageContent(testContent));
    </script>
</body>
</html>
